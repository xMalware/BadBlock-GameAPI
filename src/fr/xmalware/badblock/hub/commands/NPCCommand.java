package fr.xmalware.badblock.hub.commands;

import java.util.Arrays;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;

import org.bukkit.DyeColor;
import org.bukkit.Material;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.EntityType;

import fr.badblock.gameapi.GameAPI;
import fr.badblock.gameapi.command.AbstractCommand;
import fr.badblock.gameapi.databases.SQLRequestType;
import fr.badblock.gameapi.players.BadblockPlayer;
import fr.badblock.gameapi.players.BadblockPlayer.GamePermission;
import fr.badblock.gameapi.utils.ConfigUtils;
import fr.badblock.gameapi.utils.general.StringUtils;
import fr.badblock.gameapi.utils.i18n.I18n;
import fr.badblock.gameapi.utils.i18n.TranslatableString;
import fr.xmalware.badblock.hub.BadBlockHub;
import fr.xmalware.badblock.hub.npc.NPCData;
import net.md_5.bungee.api.ChatColor;

public class NPCCommand extends AbstractCommand {

	public NPCCommand() {
		super("npc", new TranslatableString("hub.npc.help"), GamePermission.ADMIN);
	}

	@Override
	public boolean executeCommand(CommandSender sender, String[] args) {
		if (args.length == 0) return false;
		I18n i18n = GameAPI.i18n();
		if (args[0].equalsIgnoreCase("list")) {
			Iterator<Entry<Integer, NPCData>> npcDatas = NPCData.stockage.entrySet().iterator();
			if (!npcDatas.hasNext()) {
				i18n.sendMessage(sender, "hub.npc.list_no_one");
				return true;
			}
			while (npcDatas.hasNext()) {
				Entry<Integer, NPCData> npcData = npcDatas.next();
				i18n.sendMessage(sender, "hub.npc.list_each", npcData.getKey(), npcData.getValue().getDisplayName());
			}
			return true;
		}
		if (args[0].equalsIgnoreCase("add")) {
			if (!(sender instanceof BadblockPlayer)) {
				sender.sendMessage(ChatColor.RED + "This command is only for players.");
				return true;
			}
			BadblockPlayer player = (BadblockPlayer) sender;
			// /npc add <entitytype> <highlighteditem> <dyecolor> <server> <vip> <staff> <displayname>
			// /npc add VILLAGER BED RED rush2v2 Event Rush 2v2 !
			if (args.length >= 6) {
				List<EntityType> entityTypes = Arrays.asList(EntityType.values());
				EntityType entityType = null;
				for (EntityType entityTypee : entityTypes)
					if (entityTypee.name().equals(args[1].toUpperCase())) {
						entityType = entityTypee;
						break;
					}
				if (entityType == null) {
					i18n.sendMessage(sender, "hub.npc.add_unknown_entitytype", args[1].toUpperCase());
					return true;
				}
				Material material = Material.getMaterial(args[2]);
				if (material == null) {
					i18n.sendMessage(sender, "hub.npc.add_unknown_material", args[2].toUpperCase());
					return true;
				}
				List<DyeColor> dyeColors = Arrays.asList(DyeColor.values());
				DyeColor dyeColor = null;
				for (DyeColor dyeColorr : dyeColors)
					if (dyeColorr.name().equals(args[3].toUpperCase())) {
						dyeColor = dyeColorr;
						break;
					}
				if (dyeColor == null) {
					i18n.sendMessage(sender, "hub.npc.add_unknown_dyecolor", args[3].toUpperCase());
					return true;
				}
				String serverName = args[4];
				String vipBooleanString = args[5];
				String staffBooleanString = args[6];
				String matchmakingBooleanString = args[7];
				boolean vip = false;
				boolean staff = false;
				try {
					vip = Boolean.parseBoolean(vipBooleanString.toUpperCase());
				}catch(Exception error) {
					i18n.sendMessage(sender, "hub.npc.booleanmustbeboolean");
					return true;
				}
				boolean matchmaking = false;
				try {
					matchmaking = Boolean.parseBoolean(matchmakingBooleanString.toUpperCase());
				}catch(Exception error) {
					i18n.sendMessage(sender, "hub.npc.booleanmustbeboolean");
					return true;
				}
				try {
					staff = Boolean.parseBoolean(staffBooleanString.toUpperCase());
				}catch(Exception error) {
					i18n.sendMessage(sender, "hub.npc.booleanmustbeboolean");
					return true;
				}
				String displayName = StringUtils.join(args, " ", 8);
				// id
				int id = 0;
				while(true) {
					if (NPCData.stockage.containsKey(id)) id++;
					else break;
				}
				NPCData npcData = new NPCData(ConfigUtils.convertLocationToString(player.getLocation()), entityType, material, dyeColor, vip, staff, matchmaking, displayName.replace("&", "Â°"), serverName);
				NPCData.stockage.put(id, npcData);
				GameAPI.getAPI().getSqlDatabase().call("UPDATE keyValues SET value = '" + BadBlockHub.getInstance().getGsonExpose().toJson(NPCData.stockage) + "' WHERE `key` = 'npc'", SQLRequestType.UPDATE);
				i18n.sendMessage(sender, "hub.npc.added_npc", id);
			}
			i18n.sendMessage(sender, "hub.npc.help_add");
			return true;
		}
		if (args[0].equalsIgnoreCase("remove")) {
			if (args.length >= 2) {
				String intId = args[1];
				int id = -1;
				try {
					id = Integer.parseInt(intId);
				}catch(Exception error) {
					i18n.sendMessage(sender, "hub.npc.idmustbeinteger");
					return true;
				}
				if (NPCData.stockage.containsKey(id)) {
					NPCData.stockage.get(id).remove();
					NPCData.stockage.remove(id);
				}
				GameAPI.getAPI().getSqlDatabase().call("UPDATE keyValues SET value = '" + BadBlockHub.getInstance().getGsonExpose().toJson(NPCData.stockage) + "' WHERE `key` = 'npc'", SQLRequestType.UPDATE);
				i18n.sendMessage(sender, "hub.npc.removed_npc", id);
				return true;
			}
			i18n.sendMessage(sender, "hub.npc.help_remove");
			return true;
		}
		return false;
	}

}

